var JSBitStream=function(){var e=this;this.data="";this.bitOffset=0;this.lastCharBits=0;this.readString=function(t){var n=e.readU4();var r=e.readU16();var i="";var s;while(r--){switch(n){case 5:s=e.readBits(4).data.charCodeAt(0)>>12;if(s==4){s=32}else{s+=43}break;case 4:s=e.readBits(5).data.charCodeAt(0)>>11;if(s==26){s=32}else if(s==27){s=124}else if(s==28){s=39}else if(s==29){s=45}else if(s==30){s=46}else if(s==31){s=44}else{s+=97}break;case 3:s=e.readBits(6).data.charCodeAt(0)>>10;if(s==62){s=44}else if(s==63){s=32}else{s+=48;if(s>=58)s+=7;if(s>=91)s+=6}break;case 2:s=e.readBits(7).data.charCodeAt(0)>>9;break;case 1:s=e.readBits(8).data.charCodeAt(0)>>8;break;default:s=e.readBits(16).data.charCodeAt(0);break}i+=String.fromCharCode(s)}return i};this.writeString=function(t,n,r){if(n==r)n=false;if(n)t=t.toLowerCase();var i=true;var s=true;var o=true;var u=true;var a=true;var f=true;var l=true;var c=0;var h;for(var p=0;p<t.length;p++){h=t.charCodeAt(p);if((h<43||h>57||h==47)&&h!=32)i=false;if((h<97||h>122)&&h!=32&&h!=124&&h!=39&&h!=46&&h!=44)s=false;if((h<48||h>57)&&(h<65||h>90)&&(h<97||h>122)&&h!=32&&h!=39)u=false;if(h>127)f=false;if(h>255)l=false}c=(i?5:s?4:u?3:f?2:l?1:0)&15;e.writeU4(c);e.writeU16(t.length);for(var p=0;p<t.length;p++){h=t.charCodeAt(p);switch(c){case 5:if(h==32){h=4}else{h-=43}e.writeBits(String.fromCharCode(h<<12&61440),4);break;case 4:if(h==32){h=26}else if(h==124){h=27}else if(h==39){h=28}else if(h==45){h=29}else if(h==46){h=30}else if(h==44){h=31}else{h-=97}e.writeBits(String.fromCharCode(h<<11&63488),5);break;case 3:if(h==44){h=62}else if(h==32){h=63}else{h-=48;if(h>=17)h-=7;if(h>=42)h-=6}e.writeBits(String.fromCharCode(h<<10&64512),6);break;case 2:e.writeBits(String.fromCharCode(h<<9&65024),7);break;case 1:e.writeBits(String.fromCharCode(h<<8&65280),8);break;default:e.writeBits(String.fromCharCode(h&65535),16);break}}return t};this.readInt=function(t){if(e.readFlag()){return e.readU8()}else if(e.readFlag()){return e.readU16()}else if(e.readFlag()){return e.readU32()}else{return e.readString()}};this.writeInt=function(t,n){t*=1;if(e.writeFlag(t<Math.pow(2,8))){e.writeU8(t)}else if(e.writeFlag(t<Math.pow(2,16))){e.writeU16(t)}else if(e.writeFlag(t<Math.pow(2,32))){e.writeU32(t)}else{e.writeString(t+"")}return t};this.readFloat=function(t){return(e.readU8()&255)/255};this.writeFloat=function(t,n){e.writeU8(t*255&255);return t};this.readU32=function(t){var n=e.readBits(32).data+"";return(n.charCodeAt(0)&65535)*65536+(n.charCodeAt(1)&65535)};this.writeU32=function(t,n){e.writeBits(String.fromCharCode(t>>16&65535)+String.fromCharCode(t&65535),32);return t};this.readU16=function(t){return(e.readBits(16).data+"").charCodeAt(0)&65535};this.writeU16=function(t,n){e.writeBits(String.fromCharCode(t&65535),16);return t};this.readU8=function(t){return((e.readBits(8).data+"").charCodeAt(0)&65280)>>8};this.writeU8=function(t,n){e.writeBits(String.fromCharCode((t&255)*256),8);return t};this.readU4=function(t){return((e.readBits(4).data+"").charCodeAt(0)&61440)>>12};this.writeU4=function(t,n){e.writeBits(String.fromCharCode((t&15)*4096),4);return t};this.readFlag=function(t){return((e.readBits(1).data+"").charCodeAt(0)&32768)==32768};this.writeFlag=function(t,n){e.writeBits(t?String.fromCharCode(32768):String.fromCharCode(0),1);return t};this.readBits=function(t,n){if(e.size()<t)t=e.size();var r=new JSBitStream;var i;var s=e.bitOffset;var o=t;var u="";if(e.bitOffset>0){i=Math.min(16-e.bitOffset,t);u=e.data.charCodeAt(0)<<e.bitOffset&Math.pow(2,i)-1<<16-i;r.writeBits(String.fromCharCode(u),i);e.bitOffset=(e.bitOffset+i)%16;if(e.bitOffset==0)e.data=e.data.substr(1);t-=i}while(t>0){i=Math.min(16,t);r.writeBits(String.fromCharCode(e.data.charCodeAt(0)&Math.pow(2,i)-1<<16-i),i);if(i<16){e.bitOffset=i}else{e.data=e.data.substr(1)}t-=i}if(e.size==0){e.data="";e.bitOffset=0;e.lastCharBits=0}return r};this.writeBits=function(t,n,r){var n=Math.min(n,t.length*16);var i=0;var s,o,u,a,f,l,c,h;while(i<n){s=Math.min(Math.min(16,n-i),16-i%16);o=t.charCodeAt(i/16>>0)>>16-s&Math.pow(2,s)-1;u=Math.max(e.data.length-1+(e.lastCharBits==0?1:0),0);if(e.data.length-1<u)e.data+="\0";f=Math.min(16-e.lastCharBits,s);l=o>>s-f;c=s-f;h=o&Math.pow(2,c)-1;a=e.data.charCodeAt(u)&65535;a&=Math.pow(2,e.lastCharBits)-1<<16-e.lastCharBits;a|=l<<16-(e.lastCharBits+f);e.data=e.data.substr(0,u)+String.fromCharCode(a&65535);if(c>0){e.data+="\0";a=h<<16-c;e.data=e.data.substr(0,u+1)+String.fromCharCode(a&65535)}e.lastCharBits=(e.lastCharBits+s)%16;i+=s}};this.size=function(){return e.data.length*16-e.bitOffset-(16-e.lastCharBits)%16}};if(typeof module!=="undefined"&&module.exports)module.exports.JSBitStream=JSBitStream